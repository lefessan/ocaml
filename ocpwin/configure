#!/bin/sh

# This script should be run from 4.01.0+ocp1, not from cross/
# This script takes two arguments:
# * The first argument is the system, i.e. either [mingw] or [mingw64]
# * The second argument is the absolute directory containing the binary
#   distribution of mingw for that system (downloaded from mingw-builds)
# it fills both 4.01.0+ocp1/config and 4.01.0+ocp1/cross/config with
# host and build configuration files.

confargs="$0 $*"
ocamldir=$(pwd)
ocpwindir=$(dirname $ocamldir)/ocpwin
ocamlversion=$(cat VERSION)

case "$1" in
  mingw64) 
	SYSTEM=mingw64
	MINGW_PREFIX=x86_64-w64-mingw32
	MINGW64_DIR="$2"
	OCPWIN_TARGET="64"
	shift
	shift
	;;
  mingw32) 
	SYSTEM=mingw32
	MINGW_PREFIX=i686-w64-mingw32
	MINGW64_DIR="$2"
	OCPWIN_TARGET="32"
	shift
	shift
	;;
  *) echo "Error: you must provide either 'mingw64' or 'mingw' as argument"
     exit 2;;
esac

SYSTEM_CONFIG=cross/configs/$SYSTEM

# host config
mkdir -p config
rm -f config/Makefile
rm -f config/s.h
rm -f config/m.h
echo ROOTDIR=`pwd` > config/Makefile
cat $SYSTEM_CONFIG/host/Makefile >> config/Makefile
ln -s ../$SYSTEM_CONFIG/host/m.h config/m.h
ln -s ../$SYSTEM_CONFIG/host/s.h config/s.h

# build config
mkdir -p cross/config
rm -f cross/config/Makefile
rm -f cross/config/s.h
rm -f cross/config/m.h
cp $SYSTEM_CONFIG/build/Makefile cross/config/Makefile
cp $SYSTEM_CONFIG/build/m.h cross/config/m.h
cp $SYSTEM_CONFIG/build/s.h cross/config/s.h



rm -f cross/ocaml.config
ln -s configs/$SYSTEM/host/ocaml.config cross/ocaml.config
cp VERSION cross/

DATE=$(date +"%Y%m%d")
echo "# Generated by $confargs" > cross/Makefile.config
echo  >> cross/Makefile.config
echo "OCAML_DIR=$ocamldir" >> cross/Makefile.config
echo "OCPWIN_DIR=$ocpwindir" >> cross/Makefile.config
echo "OCAMLVERSION=$ocamlversion" >> cross/Makefile.config
echo "DATE=$DATE" >> cross/Makefile.config
echo "MINGW64_DIR=$MINGW64_DIR" >> cross/Makefile.config
echo "MINGW_PREFIX=$MINGW_PREFIX" >> cross/Makefile.config
echo "MINGW_SYSTEM=$SYSTEM" >> cross/Makefile.config
echo "OCPWIN_TARGET=$OCPWIN_TARGET" >> cross/Makefile.config


echo Configured.
echo Verify that the generated cross/Makefile.config files
echo  matches your configuration.
echo 
